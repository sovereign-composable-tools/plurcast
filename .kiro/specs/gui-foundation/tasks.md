# Implementation Plan: Service Layer & Progressive UI Enhancement

## Phase 3.1: Service Layer Extraction

- [ ] 1. Create service layer infrastructure
  - [ ] 1.1 Create service module structure
    - Create `libplurcast/src/service/mod.rs`
    - Create `libplurcast/src/service/posting.rs`
    - Create `libplurcast/src/service/account.rs`
    - Create `libplurcast/src/service/draft.rs`
    - Create `libplurcast/src/service/history.rs`
    - Create `libplurcast/src/service/validation.rs`
    - Create `libplurcast/src/service/events.rs`
    - Export service types from `libplurcast/src/lib.rs`
    - _Requirements: 1.1, 1.2_
  - [ ] 1.2 Add service layer dependencies
    - Add `tokio-util` for cancellation tokens
    - Add `lru` for caching validation results
    - Update `Cargo.toml` dependencies
    - _Requirements: 1.6_
  - [ ] 1.3 Implement PlurcastService facade
    - Define `PlurcastService` struct with all sub-services
    - Implement `new()` constructor that loads config and initializes services
    - Add getter methods for each service
    - Add shared configuration and database references (Arc<RwLock<Config>>, Arc<Database>)
    - Implement `reload_config()` for hot-reloading
    - _Requirements: 1.1, 1.5_

- [ ] 2. Implement EventBus (in-process)
  - [ ] 2.1 Create event types
    - Define `Event` enum with variants:
      - PostStarted, PlatformStarted, PlatformCompleted, PostCompleted
      - AccountAdded, AccountRemoved
      - DraftCreated, DraftUpdated, DraftDeleted
      - ConfigReloaded
    - Implement `Serialize` and `Deserialize` for Event
    - Add timestamp to all events
    - _Requirements: 2.1, 2.4, 2.7_
  - [ ] 2.2 Implement EventBus struct
    - Create `EventBus` with `Arc<RwLock<Vec<Box<dyn EventHandler>>>>`
    - Implement `subscribe()` method for adding handlers
    - Implement `emit()` method for broadcasting events
    - Make event dispatch async and non-blocking
    - _Requirements: 2.2, 2.5, 2.7_
  - [ ] 2.3 Add EventHandler trait
    - Define `EventHandler` trait with `handle(&self, event: &Event)` method
    - Implement `Send + Sync` for cross-thread usage
    - _Requirements: 2.2_
  - [ ] 2.4 Add cancellation support
    - Use `tokio_util::sync::CancellationToken` for long operations
    - Add cancellation checks in posting loops
    - Emit cancellation events when operation is cancelled
    - _Requirements: 2.3_
  - [ ] 2.5 Test event system
    - Test event emission and reception
    - Test multiple subscribers
    - Test event serialization
    - Test cancellation
    - _Requirements: 11.1, 11.3_

- [ ] 3. Extract PostingService from CLI
  - [ ] 3.1 Implement PostingService struct
    - Create struct with `db: Arc<Database>`, `config: Arc<RwLock<Config>>`, `events: Arc<EventBus>`
    - Define `PostingResult`, `PlatformResult`, `PostStatus` types
    - Implement serialization for all types
    - _Requirements: 1.1, 1.3, 1.4_
  - [ ] 3.2 Move posting logic from plur-post
    - Extract `post_to_platforms()` from `plur-post/src/main.rs`
    - Extract `post_to_platform()` from `plur-post/src/main.rs`
    - Implement `PostingService::post()` with event emission
    - Implement `PostingService::post_to_all()` using default platforms
    - Support account selection per platform (HashMap<String, String>)
    - Support cancellation token parameter
    - _Requirements: 1.1, 1.3, 2.1, 2.3_
  - [ ] 3.3 Add concurrent posting orchestration
    - Use `futures::future::join_all()` for concurrent platform posts
    - Continue on individual failures
    - Aggregate results into PostingResult
    - _Requirements: 1.3, 1.7_
  - [ ] 3.4 Add error handling and aggregation
    - Collect per-platform errors
    - Determine overall PostStatus (Posted, Partial, Failed, Cancelled)
    - Map platform errors to appropriate types
    - _Requirements: 1.4, 1.5_
  - [ ] 3.5 Test PostingService
    - Test single platform posting
    - Test multi-platform posting
    - Test partial failures
    - Test cancellation
    - Test event emission
    - _Requirements: 11.1, 11.2, 11.3_

## Phase 3.2: CLI Refactoring

- [ ] 4. Update plur-post to use PostingService
  - [ ] 4.1 Refactor main.rs
    - Replace inline posting logic with `service.posting().post()` or `post_to_all()`
    - Keep stdin/argument parsing unchanged
    - Keep output formatting unchanged
    - Add `PostStatus::to_exit_code()` mapping function
    - _Requirements: 3.1, 3.3, 3.6_
  - [ ] 4.2 Add optional event subscription for verbose mode
    - Subscribe to events when `--verbose` is enabled
    - Print progress messages to stderr
    - _Requirements: 2.1, 2.2, 3.7_
  - [ ] 4.3 Test plur-post backward compatibility
    - Run all existing CLI integration tests
    - Verify identical behavior
    - Verify exit codes unchanged (0, 1, 2, 3)
    - _Requirements: 3.1, 3.2, 3.5, 3.6_

- [ ] 5. Extract HistoryService and update plur-history
  - [ ] 5.1 Implement HistoryService
    - Create struct with `db: Arc<Database>`
    - Define `HistoryFilter`, `HistoryPage`, `PostHistory`, `Statistics` types
    - Implement `query()` with filtering, pagination, sorting
    - Implement `get_post()` for single post lookup
    - Implement `get_statistics()` for analytics
    - Implement `retry_post()` for retrying failed platforms
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_
  - [ ] 5.2 Refactor plur-history
    - Replace inline query logic with `service.history().query()`
    - Build HistoryFilter from CLI arguments
    - Keep output formatting unchanged
    - _Requirements: 3.1, 3.2_
  - [ ] 5.3 Test plur-history backward compatibility
    - Run all existing CLI integration tests
    - Verify identical behavior
    - _Requirements: 3.1, 3.2_

- [ ] 6. Implement DraftService
  - [ ] 6.1 Implement DraftService struct
    - Create struct with `db: Arc<Database>`, `events: Arc<EventBus>`
    - Define `Draft` type
    - _Requirements: 7.1_
  - [ ] 6.2 Implement draft methods
    - Implement `create_draft()` - create post with status="draft"
    - Implement `update_draft()` - update post content
    - Implement `list_drafts()` - query posts where status="draft"
    - Implement `get_draft()` - get specific draft by ID
    - Implement `delete_draft()` - delete draft from database
    - Implement `set_draft_platforms()` - update metadata with platform list
    - Implement `auto_save_draft()` - silent update without event
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_
  - [ ] 6.3 Add draft events
    - Emit DraftCreated when draft is created
    - Emit DraftUpdated when draft is updated
    - Emit DraftDeleted when draft is deleted
    - _Requirements: 2.1, 7.7_
  - [ ] 6.4 Integrate drafts with posting
    - Implement `PostingService::publish_draft()` using DraftService
    - Change draft status from "draft" to "pending" before posting
    - Update status to "posted" or "failed" after posting
    - _Requirements: 7.4_
  - [ ] 6.5 Test DraftService
    - Test CRUD operations
    - Test platform targeting
    - Test publishing drafts
    - _Requirements: 11.1, 11.2_

- [ ] 7. Implement ValidationService
  - [ ] 7.1 Implement ValidationService struct
    - Create struct with `config: Arc<RwLock<Config>>`, `cache: Arc<RwLock<LruCache<u64, ValidationResult>>>`
    - Define `ValidationResult`, `PlatformValidation`, `PlatformLimits` types
    - _Requirements: 9.1, 9.2, 9.4_
  - [ ] 7.2 Implement validation methods
    - Implement `validate()` - check content against all target platforms
    - Implement `get_platform_limits()` - get platform capabilities
    - For each platform:
      - Get platform instance
      - Call platform.validate_content()
      - Count characters (handle Unicode correctly)
      - Check against character limits
    - Aggregate all platform results
    - _Requirements: 9.1, 9.3, 9.4, 9.5_
  - [ ] 7.3 Add caching for validation
    - Use LRU cache for validation results
    - Cache key: hash of (content, platforms)
    - Invalidate cache on config changes
    - Set cache size to 100 entries
    - _Requirements: 9.6, 9.7, 13.2_
  - [ ] 7.4 Test ValidationService
    - Test validation for each platform
    - Test character counting (including Unicode)
    - Test multi-platform validation
    - Test caching behavior
    - Test performance (<100ms requirement)
    - _Requirements: 11.1, 11.2, 13.2_

## Phase 3.3: Terminal UI (Ratatui)

- [ ] 8. Set up TUI project structure
  - [ ] 8.1 Create plur-tui binary
    - Create `plur-tui/` directory
    - Create `plur-tui/Cargo.toml` with dependencies:
      - ratatui
      - crossterm
      - tokio
      - libplurcast (workspace dependency)
    - Create `plur-tui/src/main.rs` with basic structure
    - Add binary to workspace members
    - _Requirements: 4.1, 4.10_
  - [ ] 8.2 Design TUI application structure
    - Create `App` struct with PlurcastService and screen states
    - Define `Screen` enum (Composer, History, Drafts, Accounts, Settings)
    - Create state structs for each screen
    - _Requirements: 4.1_

- [ ] 9. Implement Composer screen
  - [ ] 9.1 Create ComposerState struct
    - Fields: content, cursor_position, selected_platforms, validation, posting_progress
    - _Requirements: 4.2_
  - [ ] 9.2 Implement text editor widget
    - Multi-line text input
    - Cursor positioning
    - Scrolling for long content
    - _Requirements: 4.2_
  - [ ] 9.3 Add real-time validation
    - Subscribe to content changes
    - Debounce validation calls (300ms)
    - Call `service.validation().validate()`
    - Display results with character counts
    - _Requirements: 4.2, 9.1, 9.2, 13.2_
  - [ ] 9.4 Implement platform selector
    - Checkboxes for each platform
    - Show validation status per platform (✓/✗)
    - Show remaining characters
    - _Requirements: 4.3_
  - [ ] 9.5 Add posting functionality
    - Handle Ctrl+P shortcut
    - Call `service.posting().post()`
    - Show real-time progress from events
    - Display results (success/error per platform)
    - _Requirements: 4.4, 4.5_
  - [ ] 9.6 Render composer screen
    - Layout: title bar, text area, platform list, help text
    - Color coding for validation status
    - _Requirements: 4.1, 4.2, 4.3_

- [ ] 10. Implement History screen
  - [ ] 10.1 Create HistoryState struct
    - Fields: posts, filter, selected_index, page
    - _Requirements: 4.6_
  - [ ] 10.2 Implement history listing
    - Call `service.history().query()` with pagination
    - Display posts in scrollable list
    - Show post content preview, timestamp, platforms
    - _Requirements: 4.6, 8.1, 8.2, 8.3, 8.5_
  - [ ] 10.3 Add filtering and search
    - Input box for search term
    - Platform filter dropdown
    - Date range selection
    - _Requirements: 4.6, 8.2_
  - [ ] 10.4 Add post detail view
    - Show full content
    - Show all platform results
    - Allow retry of failed platforms
    - _Requirements: 4.6, 8.3, 8.7_
  - [ ] 10.5 Render history screen
    - Layout: filter bar, post list, post detail
    - Keyboard navigation
    - _Requirements: 4.1, 4.6_

- [ ] 11. Implement Drafts screen
  - [ ] 11.1 Create DraftsState struct
    - Fields: drafts, selected_index
    - _Requirements: 4.9_
  - [ ] 11.2 Implement draft listing
    - Call `service.drafts().list_drafts()`
    - Display drafts in scrollable list
    - Show content preview, timestamp
    - _Requirements: 4.9, 7.2_
  - [ ] 11.3 Add draft operations
    - Create new draft (Ctrl+N)
    - Edit draft (Enter)
    - Delete draft (Del)
    - Publish draft (Ctrl+P)
    - _Requirements: 4.9, 7.3, 7.4, 7.5_
  - [ ] 11.4 Render drafts screen
    - Layout: draft list, draft detail/editor
    - Keyboard shortcuts
    - _Requirements: 4.1, 4.9_

- [ ] 12. Implement navigation and event handling
  - [ ] 12.1 Add keyboard shortcuts
    - Tab: Switch screens
    - Ctrl+C: Quit
    - Ctrl+P: Post (in composer)
    - Ctrl+D: Save draft
    - Ctrl+H: Go to history
    - Arrow keys: Navigate
    - _Requirements: 4.7_
  - [ ] 12.2 Add mouse support
    - Click to select platforms
    - Click to switch screens
    - Scroll in lists
    - _Requirements: 4.7_
  - [ ] 12.3 Subscribe to service events
    - Create TuiEventHandler
    - Forward events to TUI event loop via channel
    - Update UI on events (posting progress, drafts created, etc.)
    - _Requirements: 2.1, 2.2, 4.4_
  - [ ] 12.4 Handle terminal resizing
    - Redraw on resize
    - Adjust layout
    - _Requirements: 4.1_

- [ ] 13. Polish and test TUI
  - [ ] 13.1 Add help screen
    - Show keyboard shortcuts
    - Show usage instructions
    - _Requirements: 14.3_
  - [ ] 13.2 Add status bar
    - Show current screen
    - Show connection status
    - Show shortcuts
    - _Requirements: 4.1_
  - [ ] 13.3 Add error handling
    - Display errors in modal
    - Allow retry
    - Allow dismiss
    - _Requirements: 4.5_
  - [ ] 13.4 Test TUI functionality
    - Test all screens
    - Test keyboard navigation
    - Test mouse input
    - Test over SSH
    - Test on different terminal emulators
    - _Requirements: 4.1, 4.7, 4.8, 11.7_
  - [ ] 13.5 Optimize rendering
    - Only redraw changed areas
    - Debounce rapid updates
    - _Requirements: 13.1, 13.2_

## Phase 3.4: Tauri Desktop Application

- [ ] 14. Set up Tauri project
  - [ ] 14.1 Initialize Tauri project
    - Create `plurcast-gui/` directory
    - Run `cargo create-tauri-app`
    - Choose Svelte/React/Vue for frontend
    - Configure Tauri in `src-tauri/tauri.conf.json`
    - _Requirements: 5.1_
  - [ ] 14.2 Add libplurcast dependency
    - Add `libplurcast` to `src-tauri/Cargo.toml`
    - Add other required dependencies
    - _Requirements: 5.7_
  - [ ] 14.3 Set up project structure
    - Frontend: `src/` (Svelte/React/Vue files)
    - Backend: `src-tauri/src/main.rs` (Tauri commands)
    - Types: Shared TypeScript types
    - _Requirements: 5.1_

- [ ] 15. Implement Tauri backend commands
  - [ ] 15.1 Set up AppState
    - Create `AppState` struct with PlurcastService
    - Initialize service in `setup()` hook
    - Use `Arc<Mutex<AppState>>` for thread safety
    - _Requirements: 5.1, 5.7_
  - [ ] 15.2 Implement posting commands
    - `post_content()` - Post to selected platforms
    - `validate_content()` - Validate content
    - _Requirements: 5.2, 5.3, 5.7_
  - [ ] 15.3 Implement draft commands
    - `create_draft()`, `list_drafts()`, `update_draft()`, `delete_draft()`, `publish_draft()`
    - _Requirements: 5.2, 5.7, 7.1, 7.7_
  - [ ] 15.4 Implement history commands
    - `query_history()` with filters
    - `get_post()` for single post
    - `retry_post()` for failed platforms
    - _Requirements: 5.6, 5.7, 8.1, 8.7_
  - [ ] 15.5 Implement account commands (future)
    - `list_accounts()`, `add_account()`, `remove_account()`, `test_account()`
    - _Requirements: 5.7, 6.1_
  - [ ] 15.6 Set up event forwarding
    - Subscribe to EventBus in setup
    - Forward events to frontend via `window.emit()`
    - _Requirements: 5.4, 5.8, 2.1_

- [ ] 16. Implement Tauri frontend
  - [ ] 16.1 Create Composer component
    - Text area for content
    - Platform checkboxes
    - Real-time validation display
    - Character counts per platform
    - Post button with loading state
    - _Requirements: 5.2, 5.3_
  - [ ] 16.2 Create History component
    - Post list with virtual scrolling
    - Filters (platform, date range, search)
    - Post detail view
    - Retry button for failed posts
    - _Requirements: 5.6_
  - [ ] 16.3 Create Drafts component
    - Draft list
    - Draft editor
    - Publish/delete actions
    - _Requirements: 5.2_
  - [ ] 16.4 Create Settings component
    - Platform configuration
    - Account management (future)
    - Preferences
    - _Requirements: 5.2_
  - [ ] 16.5 Implement navigation
    - Tabs or sidebar for screens
    - Routing if needed
    - _Requirements: 5.1_
  - [ ] 16.6 Add real-time validation
    - Debounce content changes (300ms)
    - Call `validate_content` command
    - Display results with character counts
    - Update styling based on validation
    - _Requirements: 5.3, 9.1, 13.2_
  - [ ] 16.7 Handle events
    - Listen to `plurcast-event` from backend
    - Update UI on PostStarted, PlatformCompleted, etc.
    - Show notifications for completed posts
    - _Requirements: 5.4, 5.8_

- [ ] 17. Polish and test Tauri app
  - [ ] 17.1 Add UI polish
    - Consistent styling
    - Animations and transitions
    - Loading states
    - Empty states
    - _Requirements: 5.1_
  - [ ] 17.2 Add error handling
    - User-friendly error messages
    - Retry options
    - Error details in expandable section
    - _Requirements: 5.5_
  - [ ] 17.3 Optimize performance
    - Virtual scrolling for history
    - Debounce validation
    - Lazy load settings
    - _Requirements: 5.1, 13.1, 13.4, 13.6_
  - [ ] 17.4 Add keyboard shortcuts
    - Ctrl/Cmd+N for new post
    - Ctrl/Cmd+Enter to post
    - Ctrl/Cmd+D for drafts
    - Ctrl/Cmd+H for history
    - _Requirements: 5.2_
  - [ ] 17.5 Test Tauri app
    - E2E testing with Playwright/Tauri testing tools
    - Component testing
    - Service integration testing
    - Test on Windows, macOS, Linux
    - _Requirements: 11.1, 11.2, 16.1_
  - [ ] 17.6 Package application
    - Build for Windows (.exe, .msi)
    - Build for macOS (.dmg, .app)
    - Build for Linux (.deb, .AppImage)
    - Verify binary size (<15MB)
    - _Requirements: 5.9_

## Phase 3.5: Multi-Account Support (Optional for MVP)

- [ ] 18. Implement AccountService
  - [ ] 18.1 Create accounts database schema
    - Write migration for `accounts` table
    - Add indexes on platform and (platform, is_default)
    - Update `post_records` table to include `account_id` column
    - _Requirements: 6.1_
  - [ ] 18.2 Implement credential storage
    - Define `CredentialStore` trait
    - Implement `KeyringStore` using `keyring-rs` crate (OS keyring)
    - Implement `EncryptedFileStore` with user password
    - Implement `PlainFileStore` as fallback
    - Implement `get_credential_store()` factory
    - _Requirements: 6.7, 12.1, 12.2, 12.3_
  - [ ] 18.3 Implement Account types
    - Define `Account` struct
    - Define `Credentials` enum
    - Define `AuthStatus` enum
    - _Requirements: 6.1, 6.3, 6.5_
  - [ ] 18.4 Implement AccountService methods
    - `list_accounts()` - query from database
    - `add_account()` - validate, store credentials, insert to DB
    - `remove_account()` - delete from DB and credential store
    - `test_account()` - authenticate without posting
    - `get_default_account()`, `set_default_account()`
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_
  - [ ] 18.5 Update config parsing
    - Support `[[accounts.platform]]` arrays in TOML
    - Load credentials from credential store
    - Maintain backward compatibility with single-account configs
    - _Requirements: 6.8, 16.3_
  - [ ] 18.6 Integrate accounts with posting
    - Update `PostingService::post()` to accept account IDs
    - Select default account if not specified
    - Create platform instances with account-specific credentials
    - Record account_id in post_records
    - _Requirements: 6.2, 6.4_
  - [ ] 18.7 Test AccountService
    - Test adding multiple accounts per platform
    - Test default account selection
    - Test credential storage/retrieval
    - Test authentication validation
    - _Requirements: 11.1, 11.2_

- [ ] 19. Add account UI to TUI and Tauri
  - [ ] 19.1 Add Accounts screen to TUI
    - List accounts
    - Add/remove account dialogs
    - Test authentication
    - Set default account
    - _Requirements: 4.1, 6.1, 6.8_
  - [ ] 19.2 Add Accounts management to Tauri
    - Accounts list component
    - Add account dialog
    - Credential input (secure)
    - Test authentication button
    - _Requirements: 5.2, 6.1, 6.8_
  - [ ] 19.3 Update composer to support account selection
    - Account dropdown per platform
    - Show which account will be used
    - _Requirements: 4.2, 5.2, 6.2_

## Phase 3.6: Testing & Documentation

- [ ] 20. Comprehensive testing
  - [ ] 20.1 Service layer unit tests
    - Test all service methods
    - Test event emission
    - Test error handling
    - Test concurrency
    - Achieve >80% code coverage
    - _Requirements: 11.1, 11.2, 11.3, 11.4_
  - [ ] 20.2 Integration tests
    - Test service composition
    - Test CLI using services
    - Test TUI screens
    - Test Tauri commands
    - _Requirements: 11.2, 11.5_
  - [ ] 20.3 Backward compatibility tests
    - Verify CLI behavior unchanged
    - Test config migration
    - Test database compatibility
    - _Requirements: 16.1, 16.2, 16.3, 16.5_
  - [ ] 20.4 Performance testing
    - Benchmark service layer (<1ms overhead)
    - Test TUI responsiveness (<500ms launch)
    - Test Tauri responsiveness (<2s launch)
    - Test validation speed (<100ms)
    - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7_

- [ ] 21. Documentation
  - [ ] 21.1 Service API documentation
    - Write rustdoc for all public service methods
    - Add usage examples
    - Document event types and flows
    - _Requirements: 14.1, 14.2, 14.5_
  - [ ] 21.2 TUI documentation
    - User guide with screenshots
    - Keyboard shortcuts reference
    - Common workflows
    - _Requirements: 14.3, 14.4_
  - [ ] 21.3 Tauri documentation
    - User guide with screenshots
    - Installation instructions
    - Troubleshooting guide
    - _Requirements: 14.4, 14.6_
  - [ ] 21.4 Update README
    - Add TUI and Tauri installation instructions
    - Add screenshots
    - Update architecture documentation
    - Document progression (CLI → TUI → GUI)
    - _Requirements: 14.1, 14.7, 15.7_
  - [ ] 21.5 Create troubleshooting guide
    - Common issues and solutions
    - Service debugging tips
    - TUI/GUI-specific troubleshooting
    - _Requirements: 14.6_

## Phase 3.7: Release Preparation

- [ ] 22. Prepare for release
  - [ ] 22.1 Version updates
    - Update version to 0.3.0-beta
    - Update CHANGELOG
    - Update all Cargo.toml versions
    - _Requirements: N/A_
  - [ ] 22.2 Build artifacts
    - Build CLI binaries for Windows/Mac/Linux
    - Build TUI binary
    - Build Tauri app for all platforms
    - Test all binaries
    - _Requirements: 4.10, 5.9_
  - [ ] 22.3 Create release notes
    - Document new features (service layer, TUI, Tauri)
    - Document breaking changes (if any)
    - Add upgrade guide
    - Document progression philosophy
    - _Requirements: 14.1, 14.7_
  - [ ] 22.4 Release artifacts
    - Tag release in git
    - Upload binaries to GitHub releases
    - Publish to package registries (if applicable)
    - _Requirements: N/A_
